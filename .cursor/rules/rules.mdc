---
alwaysApply: false
---

Рекомендуемый стек (production-ready)
Клиент (WebApp внутри Telegram)

TypeScript + React 18 + Vite — быстрый билд и HMR.

Telegram Web Apps SDK — initData, темы, кнопки, MainButton/BackButton.

UI: Tailwind + shadcn/ui (компактный, адаптивный UI).

Состояние: Zustand (локальное) + TanStack Query (серверное).

Realtime: socket.io-client.

Валидация: Zod (те же схемы и на бэке).

i18n: i18next (ru/en, расширяемо).

Аудио: howler.js (звуки таймера/сигнала).

Бэкенд

Node.js 20 + NestJS (структурирован, DI, модули).

Transport: REST (public API) + Socket.IO (игровые события).

Бот: grammY или Telegraf (команды, deep linking, выдача roomId).

БД: PostgreSQL (очевидный выбор для транзакций и отчётов).

ORM: Prisma (схемы = типы, миграции).

Кэш/синхронизация: Redis (скоринг, комнаты, антиспам, pub/sub адаптер для Socket.IO).

Очереди задач: BullMQ (подсчёт стат, рассылки, дедлайны финала).

Схемы: Zod (общие типы клиент↔сервер).

Хранение медиа: S3-совместимое (Cloudflare R2 / Backblaze B2) + CDN.

Верификация Telegram: серверная проверка initData (HMAC-SHA256 через токен бота), TTL проверок.

Инфраструктура

Docker для всех сервисов.

Reverse proxy: Caddy или Nginx (TLS, gzip, HTTP/2).

Деплой: Fly.io / Railway / Hetzner (VM) — WebSockets без боли. (Vercel — только для статики.)

Мониторинг: Prometheus + Grafana; логирование: pino + Loki.

Ошибки: Sentry (клиент и сервер).

CI/CD: GitHub Actions (линт/тест/миграции/деплой).

Фича-флаги: Unleash (вкл/выкл спец.клеток).

Тестирование

Unit/интеграция: Vitest (сервер и клиент).

E2E: Playwright (эмуляция webview, сценарии buzzer/таймер/финал).

Контракты: zod-to-openapi или tRPC (если хотите end-to-end типобезопасность).

#########################

Вот компактная, техничная версия правил «Своя игра» под Telegram Mini Apps, написанная так, чтобы её можно было сразу скормить ИИ (как спецификацию/промпт для генерации логики).

Цель
Набрать больше очков, чем соперники, отвечая на вопросы из категорий с разной стоимостью. В финале — сделать ставку и правильно ответить на свой последний вопрос.

Состав матча
Игроков: 2–4 (по умолчанию 3). Разрешён 1–2 бота.

Ведущий (система): управляет ходами, таймингами, баллами, проверкой ответов.

Раунды: Раунд 1 → Раунд 2 (стоимость ×2) → Финал.

Игровое поле раунда: 6 категорий × 5 уровней стоимости (например, 100/200/300/400/500 в Раунде 1).

Ход партии (пошагово)
Старт: случайно выбирается игрок, делающий первый выбор.

Выбор вопроса: активный игрок выбирает категорию и стоимость из доступных.

Озвучивание: вопрос и медиа (текст/изображение/аудио/видео) показываются всем.

Режим ответа (настраивается):

Базовый (по очереди): отвечать первым может только активный игрок.

Сигнал (buzzer): все могут «жать кнопку»; право ответа получает первый.

Таймер ответа: по умолчанию 10 секунд (конфигурируемо).

Проверка:

Автопроверка по списку правильных/допустимых ответов (алгоритм нормализации ниже).

Если неопределённо — решение за ведущим (кнопка «засчитать/не засчитать»).

Начисление/штраф:

Верно → +стоимость вопроса игроку.

Неверно/время вышло → −стоимость вопроса отвечающему.

При режиме «сигнал»: если первый ответ неверен, остальные могут сигналить до истечения общего таймера.

Право следующего выбора:

Верный ответ → право выбора у ответившего.

Иначе → право выбора у игрока, давшего последний верный ответ; если такого нет — у следующего по кругу.

Повторяем до исчерпания поля раунда.

Переход в следующий раунд: очистка поля, повышение стоимости (×2), новые категории.

Финал:

Всем показывается тема финала.

Каждый в тайне делает ставку (не более своего текущего счёта; при нуле — максимум 100/«минимальная ставка»).

Публикуется вопрос финала, единый таймер (например, 20 с).

Игроки отправляют ответы приватно ведущему; после таймера вскрытие: правильные получают +ставку, неправильные −ставку.

Побеждает максимальный итоговый счёт. При равенстве — тай-брейк (см. ниже).

Специальные клетки (включаемые флагами конфигурации)
Аукцион (Daily Double): только игрок, выбравший клетку, отвечает; перед этим объявляет ставку (от 0 до min(макс_ставка, его счёт) в текущем раунде). Начисление/штраф по ставке.

«Кот в мешке»: игрок обязан передать вопрос выбранному сопернику (или самую «слабую» категорию по ИИ-оценке); отвечать будет назначенный игрок. Ставок нет (обычный вопрос).

Блиц: серия из N коротких подвопросов по +/− фикс. стоимости, отвечать можно только выбравшему (или всем — по сигналу), общий таймер на всю серию.

Тайминги (по умолчанию, изменяемые)
Показ текста/медиа: 0,5–1,0 с «анимация».

Таймер сигнала: 3 с окно на первый клик (если режим «сигнал»).

Таймер ответа: 10 с (обычный), 15 с (медиа/аудио), 20 с (финал).

AFK: если игрок не реагирует 2 раза подряд, можно автоматически пропустить его ход до конца раунда.

Баллы и ограничения
Минимальный счёт может быть отрицательным.

В финал допускаются все, но ставка ограничена текущим счётом (при нуле разрешить «виртуальные» 100 для ставки — опция).

Для ботов: вероятность и задержка «сигнала», шанс ошибки, знание по категориям — задаются параметрами сложности.

Спорные ситуации
Синонимы, орфография, род/число/падеж — допускаются, если не меняют сущность ответа.

Требование «полного ответа» (например, имя и фамилия) помечается в данных вопроса; неполный засчитывается как неверный.

Если ответ двусмысленный — ведущий запрашивает уточнение в пределах таймера.

Тай-брейк
Один вопрос внезапной смерти с фикс. стоимостью. Режим «сигнал». Верный — победа; неверный — победа у соперника(ов) с неошибочным молчанием. Повторять до первого верного.